# DigitalOcean Deployment Guide

## ðŸš€ Deploying Agent CRM to DigitalOcean

This guide walks you through deploying the Voice AI Agent CRM system to DigitalOcean App Platform.

### Prerequisites

1. **DigitalOcean Account**: Sign up at [digitalocean.com](https://digitalocean.com)
2. **GitHub Repository**: Push your code to a GitHub repository
3. **Domain (Optional)**: For custom domain setup

### Step 1: Prepare Your Repository

1. **Push to GitHub**:
   ```bash
   git add .
   git commit -m "Prepare for DigitalOcean deployment"
   git push origin main
   ```

2. **Verify Environment Variables**: 
   - Check `.env.example` for required variables
   - Never commit actual `.env` files to Git

### Step 2: Create DigitalOcean App

1. **Login to DigitalOcean** and go to Apps section
2. **Create New App** and connect your GitHub repository
3. **Select Repository**: Choose your agent-crm repository
4. **Branch**: Select `main` branch
5. **Auto-deploy**: Enable auto-deploy on push (recommended)

### Step 3: Configure App Settings

#### Database Configuration
1. **Add Database**: 
   - Name: `crm-db`
   - Engine: PostgreSQL 15
   - Plan: Basic ($7/month)
   - Nodes: 1

#### Service Configuration
1. **Service Name**: `web`
2. **Build Command**: 
   ```bash
   npm ci && npx prisma generate && npm run build
   ```
3. **Run Command**:
   ```bash
   npx prisma migrate deploy && npm start
   ```
4. **Instance Size**: Basic (512MB RAM, $5/month)

### Step 4: Set Environment Variables

Add these environment variables in the App Platform dashboard:

#### Required Variables
```bash
# Database (auto-generated by DigitalOcean)
DATABASE_URL=${db.DATABASE_URL}

# Next.js
NODE_ENV=production
NEXTAUTH_URL=${APP_URL}
NEXTAUTH_SECRET=your-secure-32-character-secret-key

# Clerk Authentication
CLERK_SECRET_KEY=sk_live_your_clerk_secret_key
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_live_your_clerk_publishable_key

# Optional: Voice Agent
VOICE_AGENT_WEBHOOK_SECRET=your-webhook-secret
```

#### How to Generate Secrets
```bash
# NEXTAUTH_SECRET (32 characters)
openssl rand -base64 32

# General secure key
openssl rand -hex 32
```

### Step 5: Deploy

1. **Review Configuration**: Double-check all settings
2. **Create App**: Click "Create Resources"
3. **Wait for Build**: First deployment takes 5-10 minutes
4. **Monitor Logs**: Check build and runtime logs for issues

### Step 6: Post-Deployment

#### Verify Deployment
1. **Health Check**: Visit `https://your-app.ondigitalocean.app/api/health`
2. **Database**: Check that migrations ran successfully
3. **Authentication**: Test Clerk login flow
4. **API Endpoints**: Verify Voice Agent APIs work

#### Domain Setup (Optional)
1. **Add Domain**: In App settings â†’ Domains
2. **DNS Configuration**: Point your domain to DigitalOcean
3. **SSL**: Automatically provisioned by DigitalOcean

### Step 7: Production Monitoring

#### DigitalOcean Monitoring
- **Metrics**: CPU, Memory, Network usage
- **Alerts**: Set up alerts for high resource usage
- **Logs**: Monitor application and error logs

#### Application Monitoring
- **Health Endpoint**: `/api/health` for uptime monitoring
- **Database Metrics**: Monitor connection pool and query performance
- **API Performance**: Track response times and error rates

### Troubleshooting

#### Build Issues
```bash
# Check build logs in DigitalOcean dashboard
# Common issues:
# 1. Missing environment variables
# 2. Database connection during build
# 3. Prisma client generation
```

#### Runtime Issues
```bash
# Check runtime logs
# Common issues:
# 1. Database migration failures
# 2. Missing environment variables
# 3. Port binding issues
```

#### Database Issues
```bash
# Reset database (careful - this deletes data!)
npx prisma migrate reset --force

# Check migration status
npx prisma migrate status
```

### Cost Estimation

#### Monthly Costs (USD)
- **Basic App**: $5/month (512MB RAM)
- **PostgreSQL DB**: $7/month (Basic plan)
- **Bandwidth**: $0.01/GB (generous free tier)
- **Total**: ~$12/month

#### Scaling Options
- **Professional App**: $12/month (1GB RAM)
- **PostgreSQL Pro**: $15/month (1GB RAM, 10GB storage)
- **Multiple Instances**: Load balancing for high traffic

### Security Checklist

- [ ] Environment variables are set as secrets
- [ ] Database uses strong passwords
- [ ] HTTPS is enabled (automatic)
- [ ] API keys are properly scoped
- [ ] Rate limiting is configured
- [ ] CORS is properly configured

### Backup Strategy

1. **Database Backups**: DigitalOcean provides automatic backups
2. **Code Backups**: Ensure GitHub repository is up to date
3. **Environment Backups**: Document all environment variables

### Support Resources

- **DigitalOcean Docs**: [docs.digitalocean.com](https://docs.digitalocean.com)
- **Next.js Deployment**: [nextjs.org/docs/deployment](https://nextjs.org/docs/deployment)
- **Prisma Production**: [prisma.io/docs/guides/deployment](https://prisma.io/docs/guides/deployment)

---

## Quick Deploy Checklist

- [ ] Code pushed to GitHub
- [ ] DigitalOcean app created
- [ ] Database configured
- [ ] Environment variables set
- [ ] Build and run commands configured
- [ ] Deploy button clicked
- [ ] Health check passes
- [ ] Authentication tested
- [ ] Domain configured (if needed)
- [ ] Monitoring set up